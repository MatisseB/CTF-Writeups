# CSAW Finals 2016: ladykiller - Forensics 150

> I don't have the description anymore, but it had clever references to `core`, `dump`, and `debug`

For this challenge, we're given a split up zip file: `dates2.zip`, `dates2.z01`, `dates2.z02`, `dates2.z03`

**NOTE:** for some reason, trying to extract this with `unzip` or `7z` kept giving me a bunch of errors about something missing from the archive and would just quit. Not sure if that was a mistake, but either way I got it to extract with the following:

```bash
$ zip -FF dates2.zip --out d2full.zip
$ unzip d2full.zip
```

I don't know if that threw anybody off, but it would be a bit unfortunate if it did :(

I've uploaded this file [here](https://drive.google.com/open?id=0B8D2vqg5KC_obmxMQ3ViOV9faGM)

## Core Dumps
As the description suggested, we're dealing with a bunch of core dumps, and we can use `gdb` to pull out any info from them. For example:

```bash
$ file date.0
date.0: ELF 64-bit LSB core file x86-64, version 1 (SYSV), SVR4-style, from '/vagrant/Documents/CSAW-CTF-2016-Finals/Reverse/ladykiller/a.out', real uid: 1000, effective uid: 1000, real gid: 1000, effective gid: 1000, execfn: '/vagrant/Documents/CSAW-CTF-2016-Finals/Reverse/ladykiller/a.out', platform: 'x86_64'
$ gdb -c date.0
Core was generated by `/vagrant/Documents/CSAW-CTF-2016-Finals/Reverse/ladykiller/a.out'.
Program terminated with signal SIGTRAP, Trace/breakpoint trap.
#0  0x0000000000400500 in ?? ()
gdb-peda$ bt
#0  0x0000000000400500 in ?? ()
#1  0x00007ffff7a2e830 in ?? ()
#2  0x0000000000000000 in ?? ()
gdb-peda$ info registers
rax            0x400500	0x400500
rbx            0x0	0x0
rcx            0x0	0x0
rdx            0x7fffffffe5a8	0x7fffffffe5a8
rsi            0x7fffffffe598	0x7fffffffe598
rdi            0x1	0x1
rbp            0x4006d0	0x4006d0
rsp            0x7fffffffe4b8	0x7fffffffe4b8
r8             0x400740	0x400740
r9             0x7ffff7de78e0	0x7ffff7de78e0
r10            0x846	0x846
r11            0x7ffff7a2e740	0x7ffff7a2e740
r12            0x4005d0	0x4005d0
r13            0x7fffffffe590	0x7fffffffe590
r14            0x0	0x0
r15            0x0	0x0
rip            0x400500	0x400500
eflags         0x246	[ PF ZF IF ]
cs             0x33	0x33
ss             0x2b	0x2b
ds             0x0	0x0
es             0x0	0x0
fs             0x0	0x0
gs             0x0	0x0
```

The backtrace doesn't tell us much, but the registers might contain some useful info, so I dumped the registers of all the cores to a file:

```bash
$ for i in date.*; do gdb -c $i -batch -ex 'info registers'; done > regs
```

Glancing through the registers most of them didn't change/weren't interesting, but every now and then `rdx` would take on some low values:

```
rdx            0x33     0x33
...
rdx            0x5f     0x5f
...
rdx            0x6d     0x6d
...
rdx            0x7b     0x7b
...
rdx            0x66     0x66
```

Converting these to ascii, we get:

```
['3', '_', 'm', '{', 'f']
```

Looks like that could be our flag! So the plan now is simple:

1. Dump the registers of all the core dumps, but in **numerical** order, not lexicographical. So `date.3` should come before `date.11` when doing this. I only noticed this because dumping them with `date.*` in the example above results in an unclear order.
2. Pull out all values of `rdx` as ascii
3. flag???

Here's the script I wrote to do this:

```python
#!/usr/bin/env python2
from subprocess import check_output
import re
import glob
from string import printable
from itertools import groupby

# Make sure these files are sorted numerically
# i.e. "date.3" needs to be before "date.11"
cores = sorted(glob.glob('date.*'), key=lambda s: int(s.split('.')[1]))

# Dump the registers of every core file with gdb
gdb_cmd = ['gdb', '-batch']
for core in cores:
    gdb_cmd += [
        '-ex', 'core-file {}'.format(core),
        '-ex', 'info registers'
    ]
regs = check_output(gdb_cmd)

# Pull out all values of rdx as chars
rdxs = [chr(int(match.group(1), 16) & 0xff) for match in re.finditer(r'rdx\s+0x([a-fA-F0-9]+)', regs)]

# Get rid of duplicate and unprintable chars
print ''.join([val for val, grp in groupby(rdxs) if val in printable])
```
Quick note about the last line: Just printing the values of `rdx` results in something like `ffffff\x90\x90\x90\x00\x00llllll\x90\x90\x90aaaaa etc.`, so that just cleans it up.

And the output:

```bash
$ ./sol.py
BFD: Warning: /mnt/hgfs/ctf/csaw16finals/killer/dates/date.159 is truncated: expected core file size >= 2359292, found: 1900544.
Failed to read a valid object file image from memory.
0Ppflag{h3_munch_my_v3rtic4l_smil3}
```

And we have the flag:

```
flag{h3_munch_my_v3rtic4l_smil3}
```